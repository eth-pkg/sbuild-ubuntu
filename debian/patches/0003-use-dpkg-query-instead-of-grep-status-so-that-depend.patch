From 74e7d8a034e447aa8d8d17c73ef11b284e6c8b7d Mon Sep 17 00:00:00 2001
From: Johannes 'josch' Schauer <josch@mister-muffin.de>
Date: Sun, 22 Jan 2017 14:49:48 +0100
Subject: [PATCH 3/5] use dpkg-query instead of grep-status so that dependency
 on grep-dctrl is not needed anymore

---
 lib/Sbuild.pm | 23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

diff --git a/lib/Sbuild.pm b/lib/Sbuild.pm
index 61584b5b..d4ddf528 100644
--- a/lib/Sbuild.pm
+++ b/lib/Sbuild.pm
@@ -156,23 +156,26 @@ sub dump_file ($) {
 
 # set and list saved package list (used by sbuild-checkpackages)
 sub check_packages ($$) {
-    my $chroot = shift;
+    my $session = shift;
     my $mode = shift;
 
-    my $package_checklist = $chroot->get_conf('PACKAGE_CHECKLIST');
-    my $chroot_dir = $chroot->get('Location');
+    my $package_checklist = $session->get_conf('PACKAGE_CHECKLIST');
+    my $chroot_dir = $session->get('Location');
 
     my (@status, @ref, @install, @remove);
 
-    if (! open STATUS, "grep-status -F Status -s Package ' installed' '$chroot_dir/var/lib/dpkg/status' | awk '{print \$2}' |" ) {
-	print STDERR "Can't read dpkg status file in chroot: $!\n";
-	return 1;
-    }
-    while (<STATUS>) {
+    my $pipe = $session->pipe_command({
+	    COMMAND => ['dpkg-query', '--show', '--showformat=${Package} ${db:Status-Status}\n']
+	});
+    while (<$pipe>) {
 	chomp;
-	push @status, $_;
+	my @token = split / /, $_;
+	my $pkgname = shift @token;
+	my $state = shift @token;
+	next if $state ne "installed";
+	push @status, $pkgname;
     }
-    if (! close STATUS) {
+    if (! close $pipe) {
 	print STDERR "Error reading dpkg status file in chroot: $!\n";
 	return 1;
     }
-- 
2.11.0

